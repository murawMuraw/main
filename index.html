<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map {width: 100%;height: 100%;margin: 0;padding: 0;}
    #windInfo {
      position: absolute; top: 10px; left: 10px;
      padding: 10px; background: rgba(255,255,255,0.9);
      z-index: 1000; font-family: sans-serif; font-size: 14px; white-space: pre-line;
    }
    #stopBtn {
      position: absolute; top: 10px; right: 10px;
      padding: 10px; background: red; color: white;
      border: none; cursor: pointer; z-index: 1000;
    }
  </style>
</head>
<body>
<div id="windInfo">Загрузка данных...</div>
<button id="stopBtn">СТОП</button>
<div id="map"></div>

<script>
  let map, circle, arrow, historyLine;
  let path = [];

  async function fetchPath() {
    const res = await fetch('/api/path');
    if (res.ok) {
      const data = await res.json();
      path = data.path || [];
    }
  }

  async function drawPath() {
    if (path.length === 0) return;

    const lastPoint = path[path.length - 1];

    circle = new ymaps.Circle([lastPoint, 10000], {}, {
      fillColor: "#87CEEB", fillOpacity: 0.15,
      strokeColor: "#87CEEB", strokeWidth: 2, strokeOpacity: 0.6
    });
    map.geoObjects.add(circle);

    arrow = new ymaps.Placemark(lastPoint, {}, {
      preset: 'islands#redArrowIcon',
      iconRotate: true,
      iconRotation: 0
    });
    map.geoObjects.add(arrow);

    historyLine = new ymaps.Polyline(path, {}, {
      strokeColor: "#0000FF", strokeWidth: 2, strokeOpacity: 0.6
    });
    map.geoObjects.add(historyLine);
  }

  async function updatePath() {
    const res = await fetch('/api/path');
    if (res.ok) {
      const data = await res.json();
      path = data.path;
      historyLine.geometry.setCoordinates(path);
      circle.geometry.setCoordinates(path[path.length - 1]);
      arrow.geometry.setCoordinates(path[path.length - 1]);
    }
  }

  ymaps.ready(async () => {
    map = new ymaps.Map("map", {center: [51.5, 0.0], zoom: 5});
    await fetchPath();
    await drawPath();
    setInterval(updatePath, 10000); // обновляем каждые 10 сек
  });

  document.getElementById("stopBtn").addEventListener("click", async () => {
    await fetch('/api/stop', {method: 'POST'});
    alert("Движение остановлено");
  });
</script>
</body>
</html>

