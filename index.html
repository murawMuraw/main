<script>
  const apiKey = '080b3dab3f26f4e8d44b5d87f4c3ee78';
  let map, circle, arrow, historyLine;
  let moveTimer = null;
  const path = [];

  // Получение ветра по координатам
  function getWindData(lat, lon) {
    return fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`)
      .then(res => res.json())
      .then(data => {
        return {
          speed: data.wind.speed, // м/с
          deg: data.wind.deg      // откуда дует
        };
      });
  }

  ymaps.ready(() => {
    map = new ymaps.Map("map", {
      center: [51.5, 0.0],
      zoom: 5
    });

    map.events.add('click', async function (e) {
      const coords = e.get('coords');

      // Если круг уже есть, очищаем
      if (circle) {
        map.geoObjects.remove(circle);
        map.geoObjects.remove(arrow);
        map.geoObjects.remove(historyLine);
        clearInterval(moveTimer);
        path.length = 0;
      }

      // Круг
      circle = new ymaps.Circle([
        coords,
        10000
      ], {}, {
        fillColor: "#87CEEB",
        fillOpacity: 0.15,
        strokeColor: "#87CEEB",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(circle);

      // Стрелка
      arrow = new ymaps.Placemark(coords, {
        iconCaption: "ветер"
      }, {
        preset: "islands#redArrowIcon",
        iconRotate: true
      });
      map.geoObjects.add(arrow);

      // Линия траектории
      historyLine = new ymaps.Polyline([], {}, {
        strokeColor: "#0000FF",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(historyLine);

      // Запуск движения
      startMoving();
    });
  });

  function startMoving() {
    moveTimer = setInterval(async () => {
      const [lat, lon] = circle.geometry.getCoordinates();
      try {
        const wind = await getWindData(lat, lon);

        // угол КУДА дует ветер
        const moveAngle = (wind.deg + 180) * Math.PI / 180;

        const dx = wind.speed * Math.cos(moveAngle);
        const dy = wind.speed * Math.sin(moveAngle);

        const newLat = lat + (dy / 111320); 
        const newLon = lon + (dx / (40075000 * Math.cos(lat * Math.PI / 180) / 360));

        const newCoords = [newLat, newLon];
        circle.geometry.setCoordinates(newCoords);
        arrow.geometry.setCoordinates(newCoords);
        arrow.options.set('iconRotation', (wind.deg + 180) % 360);

        // История
        path.push(newCoords);
        historyLine.geometry.setCoordinates(path);

        // Текст
        document.getElementById('windInfo').innerText =
          `Скорость ветра: ${wind.speed.toFixed(1)} м/с\nНаправление (куда дует): ${(wind.deg + 180) % 360}°`;
      } catch (e) {
        console.error("Ошибка получения ветра:", e);
      }
    }, 1000);
  }
</script>
