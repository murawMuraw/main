<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с маршрутом по ветру</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="info">Кликните на карте для запуска</div>
  <div id="map"></div>

  <script>
    ymaps.ready(init);

    let map, circle, windArrow, pathLine;
    let timerId = null;

    function init() {
      map = new ymaps.Map("map", {
        center: [51.5, 0.0], // Гринвич
        zoom: 8
      });

      map.events.add('click', async function (e) {
        const coords = e.get('coords');
        await fetch(`/api/state?start=${coords[0]},${coords[1]}`);
        document.getElementById('info').innerText = 'Маршрут запущен';

        if (timerId) clearInterval(timerId);
        timerId = setInterval(updatePosition, 10000); // каждые 10 секунд
        updatePosition();
      });
    }

    async function updatePosition() {
      try {
        const res = await fetch('/api/tick');
        const state = await res.json();

        if (!state.lat || !state.lon) return;

        // Отрисовка круга
        if (circle) map.geoObjects.remove(circle);
        circle = new ymaps.Circle([
          [state.lat, state.lon],
          15000
        ], {}, {
          fillColor: "#87CEEB",
          fillOpacity: 0.1,
          strokeColor: "#87CEEB",
          strokeOpacity: 0.6,
          strokeWidth: 2
        });
        map.geoObjects.add(circle);

        // Отрисовка стрелки ветра
        if (windArrow) map.geoObjects.remove(windArrow);
        if (state.wind) {
          const iconLayout = ymaps.templateLayoutFactory.createClass(
            `<div style="transform: rotate(${state.wind.deg}deg); font-size: 24px;">⬆️</div>`
          );
          windArrow = new ymaps.Placemark([state.lat, state.lon], {}, {
            iconLayout: iconLayout,
            iconShape: { type: 'Circle', coordinates: [0, 0], radius: 10 }
          });
          map.geoObjects.add(windArrow);

          document.getElementById('info').innerText =
            `Ветер: ${state.wind.speed.toFixed(1)} м/с, направление ${state.wind.deg}°`;
        }

        // Отрисовка истории пути
        if (pathLine) map.geoObjects.remove(pathLine);
        if (state.path && state.path.length > 1) {
          pathLine = new ymaps.Polyline(state.path, {}, {
            strokeColor: "#FF0000",
            strokeWidth: 2
          });
          map.geoObjects.add(pathLine);
        }

      } catch (err) {
        console.error('Ошибка обновления:', err);
        document.getElementById('info').innerText = 'Ошибка обновления';
      }
    }
  </script>
</body>
</html>
