<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #windInfo {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.9);
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
      white-space: pre-line;
    }
    #stopBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: red;
      color: white;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>
<div id="windInfo">Кликните на карте для запуска</div>
<div id="stopBtn" style="display:none;">Закончить</div>
<div id="map"></div>

<script>
  let map, circle, arrow, historyLine;
  let moveTimer = null;
  const path = [];

  ymaps.ready(() => {
    map = new ymaps.Map("map", {
      center: [51.5, 0.0],
      zoom: 5
    });

    map.events.add('click', async function (e) {
      const coords = e.get('coords');
      try {
        const res = await fetch(`/api/state?start=${coords.join(',')}`);
        if (!res.ok) throw new Error("Ошибка старта на сервере");

        // Очищаем старые объекты
        if (circle) {
          map.geoObjects.remove(circle);
          map.geoObjects.remove(arrow);
          map.geoObjects.remove(historyLine);
          clearInterval(moveTimer);
          path.length = 0;
        }

        // Круг
        circle = new ymaps.Circle([coords, 15000], {}, {
          fillColor: "#87CEEB",
          fillOpacity: 0.15,
          strokeColor: "#87CEEB",
          strokeWidth: 2,
          strokeOpacity: 0.6
        });
        map.geoObjects.add(circle);

        // Стрелка
        arrow = new ymaps.Placemark(coords, {}, {
          preset: "islands#redArrowIcon",
          iconRotate: true
        });
        map.geoObjects.add(arrow);

        // Линия пути
        historyLine = new ymaps.Polyline([], {}, {
          strokeColor: "#0000FF",
          strokeWidth: 2,
          strokeOpacity: 0.6
        });
        map.geoObjects.add(historyLine);

        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('windInfo').innerText = "Маршрут запущен...";

        startMoving();
      } catch (err) {
        console.error(err);
        document.getElementById('windInfo').innerText = "Ошибка запуска маршрута";
      }
    });

    document.getElementById('stopBtn').addEventListener('click', async () => {
      await fetch('/api/stop');
      clearInterval(moveTimer);
      document.getElementById('windInfo').innerText = "Маршрут остановлен";
      document.getElementById('stopBtn').style.display = 'none';
    });
  });

  function startMoving() {
    moveTimer = setInterval(async () => {
      try {
        // Запрашиваем с сервера новые координаты и данные ветра
        const res = await fetch('/api/tick');
        if (!res.ok) throw new Error("Ошибка запроса tick");

        const data = await res.json();
        const { lat, lon, windDeg, windSpeed } = data;

        const newCoords = [lat, lon];
        circle.geometry.setCoordinates(newCoords);
        arrow.geometry.setCoordinates(newCoords);
        arrow.options.set('iconRotation', windDeg);
        path.push(newCoords);
        historyLine.geometry.setCoordinates(path);

        document.getElementById('windInfo').innerText =
          `Скорость ветра: ${windSpeed.toFixed(1)} м/с\nНаправление: ${windDeg}°`;
      } catch (err) {
        console.error(err);
        document.getElementById('windInfo').innerText = "Ошибка получения данных";
      }
    }, 10000); // 10 сек
  }
</script>
</body>
</html>
