<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром (серверная версия)</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    #windInfo {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.9);
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div id="windInfo">Кликните на карте для запуска</div>
<div id="controls">
  <button id="stopBtn">Закончить</button>
</div>
<div id="map"></div>

<script>
  let map, circle, arrow, historyLine;
  let moveTimer = null;
  const path = [];

  ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [51.5, 0.0], zoom: 5 });

    // Клик по карте — отправляем стартовую точку на сервер
    map.events.add('click', async function (e) {
      const coords = e.get('coords');

      // Сбрасываем старое
      if (circle) {
        map.geoObjects.remove(circle);
        map.geoObjects.remove(arrow);
        map.geoObjects.remove(historyLine);
        clearInterval(moveTimer);
        path.length = 0;
      }

      // Отправляем стартовое состояние на сервер
      await fetch(`/api/state?start=${coords.join(',')}`);

      // Создаём круг
      circle = new ymaps.Circle([coords, 15000], {}, {
        fillColor: "#87CEEB",
        fillOpacity: 0.15,
        strokeColor: "#87CEEB",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(circle);

      // Стрелка
      arrow = new ymaps.Placemark(coords, {}, {
        preset: "islands#redArrowIcon",
        iconRotate: true
      });
      map.geoObjects.add(arrow);

      // Линия пути
      historyLine = new ymaps.Polyline([], {}, {
        strokeColor: "#0000FF",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(historyLine);

      startMoving();
    });

    document.getElementById('stopBtn').addEventListener('click', async () => {
      clearInterval(moveTimer);
      await fetch('/api/stop');
    });
  });

  function startMoving() {
    moveTimer = setInterval(async () => {
      try {
        const res = await fetch('/api/tick');
        const data = await res.json();

        if (!data.coords) return;

        const [lat, lon] = data.coords;

        // Обновляем круг и стрелку
        circle.geometry.setCoordinates([lat, lon]);
        arrow.geometry.setCoordinates([lat, lon]);
        arrow.options.set('iconRotation', data.wind.deg);

        // История
        path.push([lat, lon]);
        historyLine.geometry.setCoordinates(path);

        // Инфо
        document.getElementById('windInfo').innerText =
          `Скорость ветра: ${data.wind.speed.toFixed(1)} м/с\nНаправление: ${data.wind.deg}°`;
      } catch (e) {
        console.error("Ошибка обновления:", e);
      }
    }, 10000); // каждые 10 секунд
  }
</script>
</body>
</html>
