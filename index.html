<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #windInfo {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.9);
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
      white-space: pre;
    }
  </style>
</head>
<body>
<div id="windInfo">Загрузка...</div>
<div id="map"></div>

<script>
  let map, circle, arrow, historyLine;

  async function fetchState() {
    const res = await fetch('/api/state');
    return await res.json();
  }

  function draw(state) {
    if (!map) {
      map = new ymaps.Map("map", {
        center: state.coords,
        zoom: 6
      });

      circle = new ymaps.Circle([state.coords, 10000], {}, {
        fillColor: "#87CEEB",
        fillOpacity: 0.15,
        strokeColor: "#87CEEB",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(circle);

      arrow = new ymaps.Placemark(state.coords, {}, {
        preset: "islands#redArrowIcon",
        iconRotate: true
      });
      map.geoObjects.add(arrow);

      historyLine = new ymaps.Polyline(state.path, {}, {
        strokeColor: "#0000FF",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(historyLine);
    }

    circle.geometry.setCoordinates(state.coords);
    arrow.geometry.setCoordinates(state.coords);
    arrow.options.set('iconRotation', state.windDeg);
    historyLine.geometry.setCoordinates(state.path);

    document.getElementById('windInfo').innerText =
      `Скорость ветра: ${state.windSpeed.toFixed(1)} м/с\nНаправление: ${state.windDeg}°`;
  }

  async function updateLoop() {
    const state = await fetchState();
    draw(state);
  }

  ymaps.ready(() => {
    updateLoop();
    setInterval(updateLoop, 5000); // обновление карты каждые 5 сек
  });
</script>
</body>
</html>
