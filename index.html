<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #windInfo {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.9);
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="windInfo">Кликните на карте для создания круга</div>
<div id="map"></div>

<script>
  const apiKey = '080b3dab3f26f4e8d44b5d87f4c3ee78';
  let map, circle, arrow, historyLine;
  let moveTimer = null;
  const path = [];

  // Получение ветра по координатам
  function getWindData(lat, lon) {
    return fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`)
      .then(res => res.json())
      .then(data => {
        return {
          speed: data.wind.speed,
          deg: data.wind.deg
        };
      });
  }

  ymaps.ready(() => {
    map = new ymaps.Map("map", {
      center: [51.5, 0.0],
      zoom: 5
    });

    map.events.add('click', async function (e) {
      const coords = e.get('coords');

      // Если круг уже есть, удаляем старые объекты и останавливаем таймер
      if (circle) {
        map.geoObjects.remove(circle);
        map.geoObjects.remove(arrow);
        map.geoObjects.remove(historyLine);
        clearInterval(moveTimer);
        path.length = 0;
      }

      // Создание круга в месте клика
      circle = new ymaps.Circle([
        coords,
        10000
      ], {}, {
        fillColor: "#87CEEB",
        fillOpacity: 0.15,
        strokeColor: "#87CEEB",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(circle);

      // Стрелка направления ветра
      arrow = new ymaps.Placemark(coords, {
        iconCaption: "ветер"
      }, {
        preset: "islands#redArrowIcon",
        iconRotate: true
      });
      map.geoObjects.add(arrow);

      // Линия пути
      historyLine = new ymaps.Polyline([], {}, {
        strokeColor: "#0000FF",
        strokeWidth: 2,
        strokeOpacity: 0.6
      });
      map.geoObjects.add(historyLine);

      // Начинаем движение
      startMoving();
    });
  });

  function startMoving() {
    moveTimer = setInterval(async () => {
      const [lat, lon] = circle.geometry.getCoordinates();
      try {
        const wind = await getWindData(lat, lon);
        const angleRad = ((wind.deg + 180) % 360) * Math.PI / 180;
        const speed = wind.speed; // м/с

        const dx = speed * Math.sin(angleRad);
        const dy = -speed * Math.cos(angleRad);

        const newLat = lat + (dy / 111320); // примерно м -> градусы широты
        const newLon = lon + (dx / (40075000 * Math.cos(lat * Math.PI / 180) / 360)); // долгота

        const newCoords = [newLat, newLon];
        circle.geometry.setCoordinates(newCoords);
        arrow.geometry.setCoordinates(newCoords);
        arrow.options.set('iconRotation', wind.deg);

        // Добавляем точку в историю
        path.push(newCoords);
        historyLine.geometry.setCoordinates(path);

        // Обновляем информацию
        document.getElementById('windInfo').innerText =
          `Скорость ветра: ${wind.speed.toFixed(1)} м/с\nНаправление: ${wind.deg}°`;
      } catch (e) {
        console.error("Ошибка получения ветра:", e);
      }
    }, 1000);
  }
</script>
</body>
</html>
